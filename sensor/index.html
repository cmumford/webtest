<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta charset="utf-8" name="viewport" content= "width=device-width, initial-scale=1.0">
    <title>Generic Sensor</title>
    <script>
    function $(id) {
      return document.getElementById(id);
    }
    function createHzListener(statusTagId) {
      let firstUpdateTime = 0;
      let nextUpdateTime = 0;
      let numEvents = 0;

      return (e) => {
        numEvents += 1;
        let now = Date.now();
        if (firstUpdateTime == 0) {
          firstUpdateTime = now;
          nextUpdateTime = now + 1000;
          return;
        }
        if (now >= nextUpdateTime) {
          updateRate = numEvents / ((now - firstUpdateTime) / 1000.0);
          $(statusTagId).innerHTML = 'Rate: ' + Math.round(updateRate) + ' Hz';
          nextUpdateTime = now + 1000.0;
        }
      }
    }
    function createSensor(name) {
      switch (name) {
        case 'gyroscope':
          return new Gyroscope({frequency: 60});
        case 'accelerometer':
          return new Accelerometer({frequency: 50});
        case 'magnetometer':
          return new Magnetometer({frequency: 10});
        case 'ambient-light-sensor':
          return new AmbientLightSensor({frequency: 10});
        default:
      }
    }
    function handleQuery(state, sensorName) {
      console.log(sensorName + ': ' + state);
      switch (state) {
        case 'granted':
        case 'prompt':
          try {
            let sensor = createSensor(sensorName);
            sensor.addEventListener('reading', createHzListener(sensorName));
            sensor.start();
            $(sensorName).innerHTML = 'Active.';
          } catch (e) {
            $(sensorName).innerHTML = 'Exception: ' + e.message;
          }
          break;
        default:
          $(sensorName).innerHTML = 'Denied access to ' + sensorName;
          break;
      }
    }
    function listenAll() {
      var lightSensorQuery = function() {
        // On Chrome requires GenericSensorExtraClasses.
        return navigator.permissions.query({ name: 'ambient-light-sensor' })
      }
      Promise.all([
        navigator.permissions.query({ name: 'gyroscope' }),
        navigator.permissions.query({ name: 'accelerometer' }),
        navigator.permissions.query({ name: 'magnetometer' }),
        lightSensorQuery
      ])
      .then(([
          { state: gyroState },
          { state: accelState },
          { state: magState },
          { state: lightState }]) => {

          handleQuery(gyroState, 'gyroscope');
          handleQuery(accelState, 'accelerometer');
          handleQuery(magState, 'magnetometer');
          handleQuery(lightState, 'ambient-light-sensor');
      });
    }
    function init() {
      listenAll();
    }
    </script>
  </head>
  <body onload="init()">
    <h1>Generic Sensor</h1>
    <table>
      <tr><th>Sensor</th></tr>
      <tr><td>Gyroscope: <span id="gyroscope"></span></td></tr>
      <tr><td>Accelerometer: <span id="accelerometer"></span></td></tr>
      <tr><td>Magnetometer: <span id="magnetometer"></span></td></tr>
      <tr><td>Ambient light sensor: <span id="ambient-light-sensor"></span></td></tr>
    </table>
  </body>
</html>
