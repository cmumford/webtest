<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta charset="utf-8" name="viewport" content= "width=device-width, initial-scale=1.0">
    <title>Generic Sensor</title>
    <script>
    function $(id) {
      return document.getElementById(id);
    }
    function watchGyro() {
      try {
        let gyroscope = new Gyroscope({frequency: 60});
        let started = Date.now();
        let nextUpdateTime = started + 1000.0;
        let numFrames = 0;
        gyroscope.addEventListener('reading', e => {
          numFrames += 1;
          let now = Date.now();
          if (now >= nextUpdateTime) {
            updateRate = numFrames / ((now - started) / 1000.0);
            $('gyroscope').innerHTML = 'Rate: ' + Math.round(updateRate) + ' Hz';
            nextUpdateTime = now + 1000.0;
          }
        });
        gyroscope.start();
      } catch (e) {
        console.error(e);
      }
    }
    function watchAccelerometer() {
      try {
        let accelerometer = new Accelerometer({frequency: 60});
        let started = Date.now();
        let nextUpdateTime = started + 1000.0;
        let numFrames = 0;
        accelerometer.addEventListener('reading', e => {
          numFrames += 1;
          let now = Date.now();
          if (now >= nextUpdateTime) {
            updateRate = numFrames / ((now - started) / 1000.0);
            $('accelerometer').innerHTML = 'Rate: ' + Math.round(updateRate) + ' Hz';
            nextUpdateTime = now + 1000.0;
          }
        });
        accelerometer.start();
      } catch (e) {
        console.error(e);
      }
    }
    function listenAll() {
      Promise.all([
        navigator.permissions.query({ name: 'gyroscope' }),
        navigator.permissions.query({ name: 'accelerometer' })
      ])
      .then(([
          { state: gyroState },
          { state: accelState }]) => {

        switch (gyroState) {
          case 'granted':
            console.log('Gyro: granted')
            watchGyro();
            break;
          case 'prompt':
            console.log('Gyro: prompt')
            watchGyro();
            break;
          default:
            $('gyroscope').innerHTML = 'Denied access to gyroscope';
            break;
        }

        switch (accelState) {
          case 'granted':
            console.log('Accel: granted')
            watchAccelerometer();
            break;
          case 'prompt':
            console.log('Accel: prompt')
            watchAccelerometer();
            break;
          default:
            $('accelerometer').innerHTML = 'Denied access to accelerometer';
            break;
        }
      });
    }
    function init() {
      listenAll();
    }
    </script>
  </head>
  <body onload="init()">
    <h1>Generic Sensor</h1>
    <table>
      <tr><th>Sensor</th></tr>
      <tr><td>Gyroscope: <span id="gyroscope"></span></td></tr>
      <tr><td>Accelerometer: <span id="accelerometer"></span></td></tr>
    </table>
  </body>
</html>
